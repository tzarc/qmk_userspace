#!/usr/bin/env bash

set -eEo pipefail

this_script="$(readlink -f "${BASH_SOURCE[0]}")"
script_dir="$(readlink -f "$(dirname "$this_script")")"

qmk_venv="$HOME/.local/qmk_venv"
QMK_FIRMWARE="$(readlink -f "$script_dir/../qmk_firmware")"

setup_qmk() {
    if [[ ! -d "${qmk_venv}" ]] ; then
        python3 -m pip install --user --upgrade pip
        python3 -m pip install --user --upgrade virtualenv
        python3 -m venv "${qmk_venv}"
    fi

    if [[ ! -d "${qmk_venv}" ]] ; then
        echo "Error, '${qmk_venv}' does not exist."
        exit 1
    fi

    if [[ ! -f "${qmk_venv}/bin/activate" ]] ; then
        echo "virtualenv activation script not present."
        exit 1
    fi

    exec env -i HOME="$HOME" SHELL="$SHELL" PATH="/usr/local/bin:/usr/bin:/bin" QMK_FIRMWARE="$QMK_FIRMWARE" \
        /bin/bash -c "set -e; source \"${qmk_venv}/bin/activate\"; python3 -m pip install --upgrade pip wheel; python3 -m pip install qmk; python3 -m pip install -r \"$QMK_FIRMWARE/requirements-dev.txt\""
}

if [[ ! -d "${qmk_venv}" ]] || [[ "${1:-}" == "--update" ]] || [[ "${1:-}" == "--upgrade" ]] ; then
    setup_qmk
fi

exec env -i HOME="$HOME" SHELL="$SHELL" PATH="/usr/local/bin:/usr/bin:/bin" QMK_FIRMWARE="$QMK_FIRMWARE" \
    /bin/bash -c "set -e; source \"${qmk_venv}/bin/activate\"; exec qmk $*"
